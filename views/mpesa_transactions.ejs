<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <%- include('templet/meta')-%>
        <style>
            .transaction-status {
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .status-matched {
                background-color: #d4edda;
                color: #155724;
            }

            .status-pending {
                background-color: #fff3cd;
                color: #856404;
            }

            .status-unmatched {
                background-color: #f8d7da;
                color: #721c24;
            }

            .status-failed {
                background-color: #e2e3e5;
                color: #383d41;
            }

            .mpesa-card {
                border-left: 4px solid #00a651;
            }

            .transaction-amount {
                font-size: 1.2rem;
                font-weight: 700;
                color: #00a651;
            }
        </style>
</head>

<body>
    <%- include('templet/preloder_topbar_sidebar',{titel: 'M-Pesa Transactions' })-%>

        <div class="content-body">
            <div class="container-fluid" style="min-height: 100vh;">

                <!-- Page Header -->
                <div class="row page-titles">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/index">Dashboard</a></li>
                        <li class="breadcrumb-item active">M-Pesa Transactions</li>
                    </ol>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-lg-6 col-sm-6">
                        <div class="card mpesa-card">
                            <div class="card-body">
                                <h6 class="text-muted">Total Transactions</h6>
                                <h3 id="totalCount">
                                    <%= transactions.length %>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-sm-6">
                        <div class="card" style="border-left: 4px solid #28a745;">
                            <div class="card-body">
                                <h6 class="text-muted">Matched</h6>
                                <h3 id="matchedCount">
                                    <%= transactions.filter(t=> t.status === 'matched').length %>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-sm-6">
                        <div class="card" style="border-left: 4px solid #ffc107;">
                            <div class="card-body">
                                <h6 class="text-muted">Pending</h6>
                                <h3 id="pendingCount">
                                    <%= transactions.filter(t=> t.status === 'pending').length %>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-sm-6">
                        <div class="card" style="border-left: 4px solid #dc3545;">
                            <div class="card-body">
                                <h6 class="text-muted">Unmatched</h6>
                                <h3 id="unmatchedCount">
                                    <%= transactions.filter(t=> t.status === 'unmatched').length %>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <h4 class="card-title mb-0">
                                    <i class="fas fa-mobile-alt text-success me-2"></i>
                                    M-Pesa Transactions
                                </h4>
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                                        <option value="">All Status</option>
                                        <option value="matched">Matched</option>
                                        <option value="pending">Pending</option>
                                        <option value="unmatched">Unmatched</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTransactions()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="transactionsTable">
                                        <thead>
                                            <tr>
                                                <th>Trans ID</th>
                                                <th>Date/Time</th>
                                                <th>Amount</th>
                                                <th>Phone</th>
                                                <th>Sender</th>
                                                <th>Account/Ref</th>
                                                <th>Order</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (transactions.length===0) { %>
                                                <tr>
                                                    <td colspan="9" class="text-center py-5">
                                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                        <p class="text-muted">No M-Pesa transactions yet</p>
                                                    </td>
                                                </tr>
                                                <% } else { %>
                                                    <% transactions.forEach(function(tx) { %>
                                                        <tr data-id="<%= tx.id %>" data-status="<%= tx.status %>">
                                                            <td><code><%= tx.trans_id %></code></td>
                                                            <td>
                                                                <%= new Date(tx.trans_time).toLocaleString() %>
                                                            </td>
                                                            <td class="transaction-amount">KES <%=
                                                                    parseFloat(tx.trans_amount).toLocaleString() %>
                                                            </td>
                                                            <td>
                                                                <%= tx.msisdn %>
                                                            </td>
                                                            <td>
                                                                <%= [tx.first_name, tx.middle_name,
                                                                    tx.last_name].filter(Boolean).join(' ') || ' -' %>
                                                            </td>
                                                            <td>
                                                                <%= tx.bill_ref_number || '-' %>
                                                            </td>
                                                            <td>
                                                                <% if (tx.order_id) { %>
                                                                    <a href="/order/view/<%= tx.order_id %>"
                                                                        class="btn btn-sm btn-outline-primary">
                                                                        #<%= tx.order_id %>
                                                                    </a>
                                                                    <% } else { %>
                                                                        <span class="text-muted">-</span>
                                                                        <% } %>
                                                            </td>
                                                            <td>
                                                                <span
                                                                    class="transaction-status status-<%= tx.status %>">
                                                                    <%= tx.status.charAt(0).toUpperCase() +
                                                                        tx.status.slice(1) %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <% if (tx.status==='unmatched' || tx.status==='pending'
                                                                    ) { %>
                                                                    <button class="btn btn-sm btn-outline-success"
                                                                        onclick="showMatchModal(<%= tx.id %>, '<%= tx.trans_id %>', <%= tx.trans_amount %>)">
                                                                        <i class="fas fa-link"></i> Match
                                                                    </button>
                                                                    <% } %>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Match to Order Modal -->
        <div class="modal fade" id="matchOrderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Match Payment to Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info mb-3">
                            <strong>Transaction:</strong> <span id="modalTransId"></span><br>
                            <strong>Amount:</strong> KES <span id="modalAmount"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order ID or Order Number</label>
                            <input type="text" class="form-control" id="matchOrderId" placeholder="Enter Order ID">
                            <input type="hidden" id="matchTransactionId">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="matchPayment()">
                            <i class="fas fa-link"></i> Match Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <%- include('templet/footer')-%>
            <%- include('templet/script')-%>

                <script>
                    // Filter transactions by status
                    document.getElementById('statusFilter').addEventListener('change', function () {
                        const status = this.value;
                        const rows = document.querySelectorAll('#transactionsTable tbody tr[data-status]');
                        rows.forEach(row => {
                            if (!status || row.dataset.status === status) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        });
                    });

                    // Show match modal
                    function showMatchModal(txId, transId, amount) {
                        document.getElementById('matchTransactionId').value = txId;
                        document.getElementById('modalTransId').textContent = transId;
                        document.getElementById('modalAmount').textContent = parseFloat(amount).toLocaleString();
                        document.getElementById('matchOrderId').value = '';
                        new bootstrap.Modal(document.getElementById('matchOrderModal')).show();
                    }

                    // Match payment to order
                    function matchPayment() {
                        const txId = document.getElementById('matchTransactionId').value;
                        const orderId = document.getElementById('matchOrderId').value;

                        if (!orderId) {
                            toastr.warning('Please enter an Order ID');
                            return;
                        }

                        $.ajax({
                            url: `/mpesa/match/${txId}`,
                            method: 'POST',
                            data: { orderId: orderId },
                            success: function (res) {
                                if (res.success) {
                                    toastr.success(res.message);
                                    bootstrap.Modal.getInstance(document.getElementById('matchOrderModal')).hide();
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    toastr.error(res.message || 'Failed to match payment');
                                }
                            },
                            error: function (xhr) {
                                const msg = xhr.responseJSON?.message || 'An error occurred';
                                toastr.error(msg);
                            }
                        });
                    }

                    // Refresh transactions
                    function refreshTransactions() {
                        location.reload();
                    }
                </script>

</body>

</html>